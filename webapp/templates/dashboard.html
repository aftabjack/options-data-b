<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Options Monitor</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 14px;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .stats-card {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            .stats-value {
                font-size: 1.2rem;
            }
            
            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .table {
                font-size: 11px;
            }
            
            .table th, .table td {
                padding: 0.3rem;
            }
            
            /* Hide less important columns on mobile */
            .mobile-hide {
                display: none;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .form-label {
                font-size: 12px;
                margin-bottom: 0.25rem;
            }
            
            .form-select {
                font-size: 13px;
                padding: 0.375rem 0.75rem;
            }
            
            .input-group-text {
                font-size: 12px;
                padding: 0.375rem 0.5rem;
                color: #ffffff !important;
            }
        }
        
        @media (max-width: 576px) {
            .container-fluid {
                padding: 0 8px;
            }
            
            .stats-row {
                flex-direction: column;
            }
            
            .col-md-3, .col-md-6 {
                margin-bottom: 10px;
            }
        }
        
        .navbar {
            background-color: #161b22 !important;
            border-bottom: 1px solid #30363d;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #30363d;
        }
        
        .nav-tabs .nav-link {
            color: #8b949e;
            border: none;
            padding: 12px 20px;
            margin-right: 8px;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: #1f2937;
            color: #c9d1d9;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #1f6feb;
            color: white;
            border-bottom: 2px solid #1f6feb;
        }
        
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #ffffff;
        }
        
        .card-body {
            color: #ffffff;
        }
        
        .input-group-text {
            background-color: #0d1117;
            border-color: #30363d;
            color: #ffffff;
        }
        
        .table {
            color: #ffffff;
        }
        
        .table thead th {
            background-color: #1f2937;
            color: #ffffff;
            border-color: #30363d;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table tbody tr {
            border-color: #30363d;
            transition: background-color 0.2s;
            color: #ffffff;
        }
        
        .table tbody tr:hover {
            background-color: #1f2937;
        }
        
        .table tbody td {
            color: #ffffff;
        }
        
        .btn-primary {
            background-color: #1f6feb;
            border-color: #1f6feb;
        }
        
        .btn-primary:hover {
            background-color: #388bfd;
            border-color: #388bfd;
        }
        
        .btn-add-asset {
            background-color: #238636;
            border-color: #238636;
            color: white;
        }
        
        .btn-add-asset:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        
        .dropdown-menu {
            background-color: #1f2937;
            border-color: #30363d;
        }
        
        .dropdown-item {
            color: #c9d1d9;
        }
        
        .dropdown-item:hover {
            background-color: #30363d;
            color: white;
        }
        
        .stats-card {
            background-color: #1f2937;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .stats-card .text-muted {
            color: #ffffff !important;
            opacity: 0.7;
        }
        
        .stats-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #58a6ff;
        }
        
        .positive {
            color: #3fb950 !important;
        }
        
        .negative {
            color: #f85149 !important;
        }
        
        .neutral {
            color: #8b949e !important;
        }
        
        .loading {
            display: none;
        }
        
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        
        #liveIndicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #3fb950;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-left: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .modal-content {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        
        .modal-header {
            border-bottom: 1px solid #30363d;
        }
        
        .modal-footer {
            border-top: 1px solid #30363d;
        }
        
        .form-control, .form-select {
            background-color: #0d1117;
            border-color: #30363d;
            color: #ffffff;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #0d1117;
            border-color: #1f6feb;
            color: #ffffff;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
        }
        
        .form-label {
            color: #ffffff;
        }
        
        .badge {
            font-weight: 500;
        }
        
        /* Responsive table wrapper */
        #optionsTable_wrapper {
            transition: opacity 0.15s ease-in-out;
            width: 100%;
        }
        
        /* Responsive table with min/max widths */
        #optionsTable {
            width: 100% !important;
            table-layout: auto;
        }
        
        /* Column-specific responsive widths */
        .col-symbol { 
            min-width: 120px; 
            max-width: 200px; 
            width: 15%;
        }
        
        .col-type { 
            min-width: 60px; 
            max-width: 80px; 
            width: 5%;
        }
        
        .col-strike, .col-expiry { 
            min-width: 70px; 
            max-width: 100px; 
            width: 7%;
        }
        
        .col-last, .col-mark { 
            min-width: 75px; 
            max-width: 100px; 
            width: 8%;
        }
        
        .col-volume, .col-oi { 
            min-width: 80px; 
            max-width: 120px; 
            width: 9%;
        }
        
        .col-delta, .col-theta, .col-vega, .col-iv { 
            min-width: 60px; 
            max-width: 80px; 
            width: 6%;
        }
        
        .col-gamma { 
            min-width: 70px; 
            max-width: 90px; 
            width: 7%;
        }
        
        .col-underlying { 
            min-width: 80px; 
            max-width: 110px; 
            width: 8%;
        }
        
        /* Text handling in cells */
        #optionsTable th,
        #optionsTable td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 8px 5px;
        }
        
        /* Responsive breakpoints */
        @media (max-width: 1400px) {
            .table-responsive {
                overflow-x: auto;
            }
            
            #optionsTable {
                min-width: 1000px;
            }
        }
        
        @media (max-width: 768px) {
            #optionsTable {
                min-width: 800px;
            }
            
            /* Hide less important columns on mobile */
            .col-gamma, .col-theta, .col-vega, .col-underlying {
                display: none;
            }
        }
        
        .filtering-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(31, 111, 235, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        
        /* Optimize table rendering */
        .dataTables_scrollBody {
            overflow-y: auto !important;
            max-height: 600px;
        }
        
        /* Instant feedback for dropdown changes */
        select.form-select:focus {
            transition: none !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line d-none d-sm-inline"></i> 
                <span class="d-none d-md-inline">Bybit Options</span>
                <span class="d-md-none">Options</span>
            </a>
            <div class="ms-auto d-flex align-items-center">
                <div class="form-check form-switch me-2 d-none d-md-flex">
                    <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                    <label class="form-check-label text-light" for="autoRefreshToggle">
                        <span class="d-none d-lg-inline">Auto Refresh (5s)</span>
                        <span class="d-lg-none">Auto</span>
                    </label>
                </div>
                <button class="btn btn-sm btn-outline-light me-2" id="refreshBtn" onclick="refreshData(true)">
                    <i class="fas fa-sync-alt"></i>
                    <span class="d-none d-sm-inline">Refresh</span>
                </button>
                <span class="badge bg-success d-none d-sm-inline-block">
                    <i class="fas fa-circle"></i> Live
                    <span id="liveIndicator"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Stats Row -->
        <div class="row mb-3 stats-row">
            <div class="col-6">
                <div class="stats-card">
                    <div class="text-muted small">Total Options</div>
                    <div class="stats-value" id="totalSymbols">-</div>
                </div>
            </div>
            <div class="col-6">
                <div class="stats-card">
                    <div class="text-muted small">Last Updated</div>
                    <div class="stats-value" id="lastUpdate">-</div>
                </div>
            </div>
        </div>

        <!-- Asset Tabs -->
        <ul class="nav nav-tabs" id="assetTabs" role="tablist">
            {% for symbol, info in assets.items() %}
                {% if info.enabled %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" 
                            id="{{ symbol }}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#{{ symbol }}-content" 
                            type="button" 
                            role="tab"
                            onclick="loadAssetData('{{ symbol }}')">
                        {{ symbol }}
                    </button>
                </li>
                {% endif %}
            {% endfor %}
            <li class="nav-item ms-auto d-none d-md-block" role="presentation">
                <button class="btn btn-add-asset btn-sm mt-2 me-2" onclick="showAddAssetModal()">
                    <i class="fas fa-plus"></i> <span class="d-none d-lg-inline">Add Asset</span>
                </button>
                <button class="btn btn-secondary btn-sm mt-2" onclick="showSettingsModal()">
                    <i class="fas fa-cog"></i> <span class="d-none d-lg-inline">Settings</span>
                </button>
                <button class="btn btn-info btn-sm mt-2" onclick="showColumnModal()">
                    <i class="fas fa-columns"></i> <span class="d-none d-lg-inline">Columns</span>
                </button>
            </li>
        </ul>

        <!-- Filters -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-12 col-md-3">
                        <label class="form-label">Expiry Date</label>
                        <select class="form-select form-select-sm" id="expiryFilter" onchange="handleExpiryChange()">
                            <option value="all">All Expiries</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Option Type</label>
                        <select class="form-select form-select-sm" id="typeFilter" onchange="applyFilters()">
                            <option value="all">All Options</option>
                            <option value="call">Calls Only</option>
                            <option value="put">Puts Only</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="badge bg-info">Total: <span id="totalOptionsCount">0</span> options</span>
                        <span class="badge bg-success ms-2">Displayed: <span id="displayedCount">0</span></span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshData(true)">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="loading text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="filtering-indicator">
                    <i class="fas fa-filter"></i> Filtering...
                </div>
                <div class="table-responsive">
                    <table id="optionsTable" class="table table-dark table-striped table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Expiry</th>
                                <th class="d-none d-md-table-cell">Last</th>
                                <th>Mark</th>
                                <th>Vol</th>
                                <th class="d-none d-lg-table-cell">OI</th>
                                <th>Delta</th>
                                <th class="d-none d-xl-table-cell">Gamma</th>
                                <th class="d-none d-xl-table-cell">Theta</th>
                                <th class="d-none d-xl-table-cell">Vega</th>
                                <th>IV</th>
                                <th class="d-none d-lg-table-cell">Underlying</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div class="modal fade" id="addAssetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newAssetSymbol" class="form-label">Symbol (e.g., XRP, MATIC)</label>
                        <input type="text" class="form-control" id="newAssetSymbol" 
                               placeholder="Enter symbol" maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label for="newAssetName" class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="newAssetName" 
                               placeholder="Enter name (optional)">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        The system will test if this asset has options on Bybit before adding.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="testAssetBtn" onclick="testAsset()">
                        <i class="fas fa-vial"></i> Test
                    </button>
                    <button type="button" class="btn btn-success" id="addAssetBtn" onclick="addAsset()" disabled>
                        <i class="fas fa-plus"></i> Add Asset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asset Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assetSettingsTable">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Visibility Modal -->
    <div class="modal fade" id="columnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Column Visibility Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Select columns to display in the table:</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-symbol" checked>
                                <label class="form-check-label" for="col-symbol">Symbol</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-type" checked>
                                <label class="form-check-label" for="col-type">Type (Call/Put)</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-strike" checked>
                                <label class="form-check-label" for="col-strike">Strike Price</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-expiry" checked>
                                <label class="form-check-label" for="col-expiry">Expiry Date</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-last" checked>
                                <label class="form-check-label" for="col-last">Last Price</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-mark" checked>
                                <label class="form-check-label" for="col-mark">Mark Price</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-volume" checked>
                                <label class="form-check-label" for="col-volume">24h Volume</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-oi" checked>
                                <label class="form-check-label" for="col-oi">Open Interest</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-delta" checked>
                                <label class="form-check-label" for="col-delta">Delta</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-gamma">
                                <label class="form-check-label" for="col-gamma">Gamma</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-theta">
                                <label class="form-check-label" for="col-theta">Theta</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-vega">
                                <label class="form-check-label" for="col-vega">Vega</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-iv" checked>
                                <label class="form-check-label" for="col-iv">Implied Volatility</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="col-underlying">
                                <label class="form-check-label" for="col-underlying">Underlying Price</label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-sm btn-secondary" onclick="applyPresetColumns('basic')">Basic View</button>
                            <button class="btn btn-sm btn-secondary" onclick="applyPresetColumns('trader')">Trader View</button>
                            <button class="btn btn-sm btn-secondary" onclick="applyPresetColumns('greeks')">Greeks Focus</button>
                            <button class="btn btn-sm btn-secondary" onclick="applyPresetColumns('all')">Show All</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        let currentAsset = 'BTC';
        let optionsTable = null;
        let autoRefreshInterval = null;
        let eventSource = null;
        let allOptionsData = [];
        let fullOptionsCache = {}; // Cache all options by asset
        let filterResultCache = {}; // Cache filtered results
        // let currentPrice = 0;  // Removed - Market Info section removed
        // let atmStrike = 0;  // Removed - Market Info section removed

        // Initialize
        $(document).ready(function() {
            // Pre-populate Call/Put dropdown immediately (no waiting)
            $('#typeFilter').html(`
                <option value="all">All Options</option>
                <option value="call">Calls Only</option>
                <option value="put">Puts Only</option>
            `);
            
            // Initialize DataTable with responsive design
            optionsTable = $('#optionsTable').DataTable({
                pageLength: 50,
                lengthMenu: [[10, 25, 50, 100, 250, 500, -1], [10, 25, 50, 100, 250, 500, "All"]],
                order: [[6, 'desc']], // Sort by volume
                deferRender: true, // Only render visible rows
                processing: true, // Show processing indicator
                responsive: false, // We'll handle responsiveness ourselves
                scrollX: true, // Enable horizontal scrolling on mobile
                autoWidth: true, // Let DataTables calculate widths
                columns: [
                    { data: 'symbol', className: 'col-symbol' },
                    { data: 'type', render: renderType, className: 'col-type' },
                    { data: 'strike', className: 'col-strike' },
                    { data: 'expiry', className: 'col-expiry' },
                    { data: 'last_price', render: renderPrice, className: 'col-last' },
                    { data: 'mark_price', render: renderPrice, className: 'col-mark' },
                    { data: 'volume_24h', render: renderVolume, className: 'col-volume' },
                    { data: 'open_interest', render: renderNumber, className: 'col-oi' },
                    { data: 'delta', render: renderDelta, className: 'col-delta' },
                    { data: 'gamma', render: renderSmallNumber, className: 'col-gamma' },
                    { data: 'theta', render: renderTheta, className: 'col-theta' },
                    { data: 'vega', render: renderNumber, className: 'col-vega' },
                    { data: 'iv', render: renderIV, className: 'col-iv' },
                    { data: 'underlying', render: renderPrice, className: 'col-underlying' }
                ]
            });

            // Load column settings
            loadColumnSettings();
            
            // Load initial data
            loadAssetData(currentAsset);
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Start stats stream
            startStatsStream();
        });

        // Rendering functions
        function renderType(data) {
            const color = data === 'Call' ? 'success' : 'danger';
            return `<span class="badge bg-${color}">${data}</span>`;
        }

        function renderPrice(data) {
            if (data === null || data === undefined) return '-';
            return `$${parseFloat(data).toFixed(2)}`;
        }

        function renderVolume(data) {
            if (data === null || data === undefined) return '-';
            if (data === 0) return '0';
            if (data > 1000000) return `${(data/1000000).toFixed(2)}M`;
            if (data > 1000) return `${(data/1000).toFixed(2)}K`;
            return data.toFixed(0);
        }

        function renderNumber(data) {
            if (data === null || data === undefined) return '-';
            return parseFloat(data).toFixed(4);
        }

        function renderDelta(data) {
            if (data === null || data === undefined) return '-';
            const value = parseFloat(data);
            const color = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            return `<span class="${color}">${value.toFixed(4)}</span>`;
        }

        function renderTheta(data) {
            if (data === null || data === undefined) return '-';
            const value = parseFloat(data);
            const color = value < 0 ? 'negative' : 'neutral';
            return `<span class="${color}">${value.toFixed(2)}</span>`;
        }

        function renderSmallNumber(data) {
            if (data === null || data === undefined) return '-';
            return parseFloat(data).toFixed(6);
        }

        function renderIV(data) {
            if (data === null || data === undefined) return '-';
            if (data === 0) return '0.0%';
            return `${(parseFloat(data) * 100).toFixed(1)}%`;
        }

        // Load asset data - OPTIMIZED VERSION
        function loadAssetData(asset) {
            currentAsset = asset;
            $('.loading').show();
            
            // Check if we have cached data for this asset
            if (fullOptionsCache[asset]) {
                // Use cached data
                allOptionsData = fullOptionsCache[asset];
                
                // Update current price and ATM from cached data
                if (allOptionsData.length > 0) {
                    // Market Info removed - no need to update price
                    // currentPrice = allOptionsData[0].index_price || allOptionsData[0].underlying || 0;
                    // $('#currentPrice').text(`$${currentPrice.toFixed(2)}`);
                    // findATMStrike(allOptionsData);
                }
                
                loadExpiriesAndFilter();
                return;
            }
            
            // Load ALL options data once (for all expiries)
            $.get(`/api/options/${asset}`, {
                expiry: 'all'
            }, function(data) {
                // Cache the full dataset
                fullOptionsCache[asset] = data;
                allOptionsData = data;
                
                // Update current price and ATM
                if (data.length > 0) {
                    // Use index price from the first option (all options should have similar index price)
                    // If index_price is not available, fall back to underlying
                    // Market Info removed - no need to update price
                    // currentPrice = data[0].index_price || data[0].underlying || 0;
                    // $('#currentPrice').text(`$${currentPrice.toFixed(2)}`);
                    // findATMStrike(data);
                }
                
                // Load expiries and filter
                loadExpiriesAndFilter();
                
            }).fail(function() {
                $('.loading').hide();
                console.error('Failed to load options data');
            });
        }
        
        // Load expiries dropdown and filter data
        function loadExpiriesAndFilter() {
            const asset = currentAsset;
            
            // Get unique expiries from the data (no counting needed)
            const expirySet = new Set();
            allOptionsData.forEach(option => {
                if (option.expiry) {
                    expirySet.add(option.expiry);
                }
            });
            
            // Sort expiries
            const expiries = Array.from(expirySet).sort();
            
            const select = $('#expiryFilter');
            select.html(`<option value="all">All Expiries</option>`);
            
            expiries.forEach((exp) => {
                // Format date nicely without count
                const dateStr = exp.replace(/^(\d{2})(\w{3})(\d{2})$/, '$1-$2-$3');
                select.append(`<option value="${exp}">${dateStr}</option>`);
            });
            
            // Default to "All Expiries" to show all data
            select.val('all');
            
            // Apply filters immediately (no API call needed) and reset to page 1
            filterAndDisplay(true);
        }
        
        // Handle expiry change (instant filtering)
        function handleExpiryChange() {
            filterAndDisplay(true); // true = reset to page 1
        }

        // Filter and display data with caching
        function filterAndDisplay(resetPage = false) {
            const expiry = $('#expiryFilter').val();
            const typeFilter = $('#typeFilter').val();
            
            // Create cache key for this filter combination
            const cacheKey = `${currentAsset}_${expiry}_${typeFilter}`;
            
            // Check if we have cached results for this exact filter
            if (filterResultCache[cacheKey]) {
                displayFilteredData(filterResultCache[cacheKey], resetPage);
                return;
            }
            
            // Start with cached full dataset
            let filtered = fullOptionsCache[currentAsset] || allOptionsData;
            
            // Filter by expiry
            if (expiry && expiry !== 'all') {
                filtered = filtered.filter(item => item.expiry === expiry);
            }
            
            // Filter by type
            if (typeFilter !== 'all') {
                filtered = filtered.filter(item => {
                    if (typeFilter === 'call') {
                        return item.type === 'Call';
                    } else if (typeFilter === 'put') {
                        return item.type === 'Put';
                    }
                    return true;
                });
            }
            
            // Cache the filtered results
            filterResultCache[cacheKey] = filtered;
            
            // Display the filtered data
            displayFilteredData(filtered, resetPage);
        }
        
        // Display filtered data (separated for reuse)
        function displayFilteredData(filtered, resetPage = false) {
            // Save current scroll position
            const scrollBody = $('.dataTables_scrollBody');
            const scrollTop = scrollBody.scrollTop();
            const windowScrollY = window.scrollY;
            
            // Save current page info
            const pageInfo = optionsTable.page.info();
            const currentPage = pageInfo.page;
            
            // Show subtle transition
            $('#optionsTable_wrapper').css('opacity', '0.7');
            
            // Update counts
            $('#totalOptionsCount').text(filtered.length);
            $('#displayedCount').text(filtered.length);
            
            // Find ATM for filtered data
            if (filtered.length > 0) {
                // findATMStrike(filtered);  // Market Info removed
            }
            
            // Update table with optimized redraw
            optionsTable.clear();
            optionsTable.rows.add(filtered);
            
            if (resetPage) {
                // Reset to first page when filters change
                optionsTable.page(0).draw(false);
            } else {
                // For auto-refresh, try to stay on current page
                optionsTable.draw(false);
                
                // Restore page if it still exists
                const newPageInfo = optionsTable.page.info();
                if (currentPage < newPageInfo.pages) {
                    optionsTable.page(currentPage).draw(false);
                }
            }
            
            // Restore scroll positions
            scrollBody.scrollTop(scrollTop);
            window.scrollTo(0, windowScrollY);
            
            // Restore opacity
            setTimeout(() => {
                $('#optionsTable_wrapper').css('opacity', '1');
            }, 100);
            
            $('.loading').hide();
        }
        
        // Refresh data (for auto-refresh and manual refresh)
        function refreshData(isManual = false) {
            const asset = currentAsset;
            
            // Don't refresh if user is interacting with dropdowns or typing
            if (!isManual) {
                // Check if any dropdown is open or focused
                if ($('select:focus').length > 0 || $('.dropdown-menu:visible').length > 0) {
                    return; // Skip this refresh cycle
                }
                
                // Check if user is selecting text in the table
                if (window.getSelection().toString()) {
                    return; // Skip if text is selected
                }
            }
            
            // Clear filter cache when refreshing data
            filterResultCache = {};
            
            // Show subtle loading indicator
            $('#refreshBtn').find('i').addClass('fa-spin');
            
            // Reload ALL data
            $.get(`/api/options/${asset}`, {
                expiry: 'all'
            }, function(data) {
                // Update cache
                fullOptionsCache[asset] = data;
                allOptionsData = data;
                
                // Update current price
                if (data.length > 0) {
                    // currentPrice = data[0].underlying;  // Market Info removed
                    // $('#currentPrice').text(`$${currentPrice.toFixed(2)}`);  // Market Info removed
                }
                
                // Re-filter with current settings
                filterAndDisplay();
                
                $('#refreshBtn').find('i').removeClass('fa-spin');
            });
        }
        
        // Market Info section removed - findATMStrike no longer needed
        // function findATMStrike(data) {
        //     const strikes = [...new Set(data.map(o => parseFloat(o.strike)))].sort((a, b) => a - b);
        //     let minDiff = Infinity;
        //     
        //     strikes.forEach(strike => {
        //         const diff = Math.abs(strike - currentPrice);
        //         if (diff < minDiff) {
        //             minDiff = diff;
        //             atmStrike = strike;
        //         }
        //     });
        //     
        //     $('#atmStrike').text(`ATM: ${atmStrike}`);
        // }

        // Apply filters (redirect to filterAndDisplay for consistency)
        function applyFilters() {
            filterAndDisplay(true); // true = reset to page 1 when filters change
        }

        // Auto refresh
        function startAutoRefresh() {
            const checkbox = $('#autoRefreshToggle');
            
            if (checkbox.is(':checked')) {
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                autoRefreshInterval = setInterval(refreshData, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        // Initialize auto refresh toggle
        $('#autoRefreshToggle').change(function() {
            startAutoRefresh();
        });

        // Stats stream
        function startStatsStream() {
            eventSource = new EventSource('/api/stream');
            
            eventSource.onmessage = function(event) {
                const stats = JSON.parse(event.data);
                
                $('#totalSymbols').text(stats.total_symbols || '-');
                // $('#messagesProcessed').text(formatNumber(stats.messages_processed || 0));  // Removed from UI
                // $('#memoryUsage').text(stats.redis_memory || '-');  // Removed from UI
                
                if (stats.last_update) {
                    const date = new Date(parseFloat(stats.last_update) * 1000);
                    $('#lastUpdate').text(date.toLocaleTimeString());
                }
            };
        }

        // Format numbers
        function formatNumber(num) {
            if (num > 1000000) return `${(num/1000000).toFixed(1)}M`;
            if (num > 1000) return `${(num/1000).toFixed(1)}K`;
            return num.toString();
        }

        // Modal functions
        function showAddAssetModal() {
            $('#addAssetModal').modal('show');
        }

        function showSettingsModal() {
            // Load current assets
            $.get('/api/assets', function(assets) {
                const tbody = $('#assetSettingsTable');
                tbody.empty();
                
                Object.entries(assets).forEach(([symbol, info]) => {
                    const statusBadge = info.enabled 
                        ? '<span class="badge bg-success">Enabled</span>'
                        : '<span class="badge bg-secondary">Disabled</span>';
                    
                    const toggleBtn = info.enabled
                        ? `<button class="btn btn-sm btn-warning" onclick="toggleAsset('${symbol}')">Disable</button>`
                        : `<button class="btn btn-sm btn-success" onclick="toggleAsset('${symbol}')">Enable</button>`;
                    
                    const removeBtn = ['BTC', 'ETH', 'SOL'].includes(symbol)
                        ? '<button class="btn btn-sm btn-danger" disabled>Default</button>'
                        : `<button class="btn btn-sm btn-danger" onclick="removeAsset('${symbol}')">Remove</button>`;
                    
                    tbody.append(`
                        <tr>
                            <td>${symbol}</td>
                            <td>${info.name}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${toggleBtn}
                                ${removeBtn}
                            </td>
                        </tr>
                    `);
                });
            });
            
            $('#settingsModal').modal('show');
        }

        // Asset management
        function testAsset() {
            const symbol = $('#newAssetSymbol').val().toUpperCase();
            
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            
            // Show loading state
            $('#testAssetBtn').prop('disabled', true).text('Testing...');
            
            $.ajax({
                url: '/api/assets/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ symbol: symbol }),
                success: function(response) {
                    $('#testAssetBtn').prop('disabled', false).text('Test');
                    if (response.success) {
                        alert(`✅ Success! ${response.message}`);
                        // Enable the Add button if test passed
                        $('#addAssetBtn').prop('disabled', false);
                    } else {
                        alert(`❌ Failed: ${response.message}`);
                        $('#addAssetBtn').prop('disabled', true);
                    }
                },
                error: function(xhr) {
                    $('#testAssetBtn').prop('disabled', false).text('Test');
                    alert(`Error: ${xhr.responseJSON?.detail || 'Failed to test asset'}`);
                }
            });
        }

        function addAsset() {
            const symbol = $('#newAssetSymbol').val().toUpperCase();
            const name = $('#newAssetName').val() || symbol;
            
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            
            $.ajax({
                url: '/api/assets/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ symbol: symbol, name: name }),
                success: function(response) {
                    alert(`Successfully added ${symbol}`);
                    location.reload();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON.error || 'Failed to add asset';
                    alert(error);
                }
            });
        }

        function toggleAsset(symbol) {
            $.post(`/api/assets/${symbol}/toggle`, function() {
                showSettingsModal(); // Refresh
            });
        }

        // Column Visibility Functions
        let columnSettings = {};
        
        function loadColumnSettings() {
            // Load from localStorage
            const saved = localStorage.getItem('columnVisibility');
            if (saved) {
                columnSettings = JSON.parse(saved);
            } else {
                // Default settings
                columnSettings = {
                    symbol: true,
                    type: true,
                    strike: true,
                    expiry: true,
                    last: true,
                    mark: true,
                    volume: true,
                    oi: true,
                    delta: true,
                    gamma: false,
                    theta: false,
                    vega: false,
                    iv: true,
                    underlying: false
                };
            }
            
            // Apply settings to checkboxes
            Object.keys(columnSettings).forEach(col => {
                const checkbox = document.getElementById(`col-${col}`);
                if (checkbox) {
                    checkbox.checked = columnSettings[col];
                }
            });
            
            // Apply to DataTable
            applyColumnVisibility();
        }
        
        function showColumnModal() {
            // Load current settings to modal
            loadColumnSettings();
            $('#columnModal').modal('show');
        }
        
        function applyColumnSettings() {
            // Get settings from checkboxes
            const columns = ['symbol', 'type', 'strike', 'expiry', 'last', 'mark', 
                           'volume', 'oi', 'delta', 'gamma', 'theta', 'vega', 'iv', 'underlying'];
            
            columns.forEach((col, index) => {
                const checkbox = document.getElementById(`col-${col}`);
                if (checkbox) {
                    columnSettings[col] = checkbox.checked;
                    // Apply to DataTable
                    optionsTable.column(index).visible(checkbox.checked);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('columnVisibility', JSON.stringify(columnSettings));
            
            // Close modal
            $('#columnModal').modal('hide');
        }
        
        function applyColumnVisibility() {
            if (!optionsTable) return;
            
            const columnMap = {
                symbol: 0, type: 1, strike: 2, expiry: 3,
                last: 4, mark: 5, volume: 6, oi: 7,
                delta: 8, gamma: 9, theta: 10, vega: 11,
                iv: 12, underlying: 13
            };
            
            Object.keys(columnSettings).forEach(col => {
                const index = columnMap[col];
                if (index !== undefined) {
                    optionsTable.column(index).visible(columnSettings[col]);
                }
            });
        }
        
        function applyPresetColumns(preset) {
            const presets = {
                basic: {
                    symbol: true, type: true, strike: true, expiry: true,
                    last: true, mark: true, volume: true, oi: false,
                    delta: false, gamma: false, theta: false, vega: false,
                    iv: false, underlying: false
                },
                trader: {
                    symbol: true, type: true, strike: true, expiry: true,
                    last: true, mark: true, volume: true, oi: true,
                    delta: true, gamma: false, theta: false, vega: false,
                    iv: true, underlying: true
                },
                greeks: {
                    symbol: true, type: true, strike: true, expiry: false,
                    last: false, mark: true, volume: false, oi: false,
                    delta: true, gamma: true, theta: true, vega: true,
                    iv: true, underlying: false
                },
                all: {
                    symbol: true, type: true, strike: true, expiry: true,
                    last: true, mark: true, volume: true, oi: true,
                    delta: true, gamma: true, theta: true, vega: true,
                    iv: true, underlying: true
                }
            };
            
            if (presets[preset]) {
                Object.keys(presets[preset]).forEach(col => {
                    const checkbox = document.getElementById(`col-${col}`);
                    if (checkbox) {
                        checkbox.checked = presets[preset][col];
                    }
                });
            }
        }
        
        function removeAsset(symbol) {
            if (confirm(`Remove ${symbol} from monitoring?`)) {
                $.ajax({
                    url: `/api/assets/${symbol}/remove`,
                    method: 'DELETE',
                    success: function() {
                        location.reload();
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.error || 'Failed to remove asset');
                    }
                });
            }
        }
    </script>
</body>
</html>